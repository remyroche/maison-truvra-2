// website/admin/js/admin_products.js
let productsForAdmin = [];
let editingProductId = null;

function initializeProductManagement() {
    // ... (same as previous, no changes needed here for i18n specifically)
    const showFormButton = document.getElementById('show-add-product-form-button');
    const productFormSection = document.getElementById('add-edit-product-section');
    const productForm = document.getElementById('product-form');
    const cancelFormButton = document.getElementById('cancel-product-form-button');
    const addWeightOptionButton = document.getElementById('add-weight-option-button');
    const assetsPreviewSection = document.getElementById('product-assets-preview-section');

    if (showFormButton && productFormSection) {
        showFormButton.addEventListener('click', () => {
            editingProductId = null;
            if (productForm) productForm.reset();
            clearFormErrors(productForm);
            const formTitle = document.getElementById('product-form-title');
            if (formTitle) formTitle.textContent = "Ajouter un Nouveau Produit";
            const productIdField = document.getElementById('product-id');
            if (productIdField) productIdField.readOnly = false;
            const weightOptionsContainer = document.getElementById('weight-options-container');
            if (weightOptionsContainer) weightOptionsContainer.innerHTML = '';
            if(assetsPreviewSection) assetsPreviewSection.style.display = 'none';
            productFormSection.style.display = 'block';
            showFormButton.style.display = 'none';
        });
    }

    if (cancelFormButton && productFormSection && showFormButton) {
        cancelFormButton.addEventListener('click', () => {
            productFormSection.style.display = 'none';
            showFormButton.style.display = 'inline-flex';
            if (productForm) productForm.reset();
            clearFormErrors(productForm);
            editingProductId = null;
            if(assetsPreviewSection) assetsPreviewSection.style.display = 'none';
        });
    }

    if (productForm) {
        productForm.addEventListener('submit', handleProductFormSubmit);
    }

    if (addWeightOptionButton) {
        addWeightOptionButton.addEventListener('click', () => addWeightOptionRow());
    }

    loadAdminProductsList();
}

function addWeightOptionRow(option = { option_id: null, weight_grams: '', price: '', initial_stock: '' }) {
    // ... (same as previous)
    const container = document.getElementById('weight-options-container');
    if (!container) return;
    const optionIndex = container.children.length;
    const optionIdInputHtml = option.option_id ? `<input type="hidden" name="weight_options[<span class="math-inline">\{optionIndex\}\]\[option\_id\]" value\="</span>{option.option_id}">` : '';
    const rowHtml = `
        <div class="weight-option-row grid grid-cols-1 md:grid-cols-4 gap-3 items-center border p-3 rounded-md mb-2">
            <span class="math-inline">\{optionIdInputHtml\}
<div\><label class\="text\-xs font\-medium text\-brand\-near\-black"\>Poids \(g\) <span class\="text\-red\-500"\>\*</span\></label\><input type\="number" name\="weight\_options\[</span>{optionIndex}][weight_grams]" class="form-input-admin text-sm p-2 mt-1" value="<span class="math-inline">\{option\.weight\_grams\}" placeholder\="Ex\: 20" required\></div\>
<div\><label class\="text\-xs font\-medium text\-brand\-near\-black"\>Prix \(€\) <span class\="text\-red\-500"\>\*</span\></label\><input type\="number" name\="weight\_options\[</span>{optionIndex}][price]" step="0.01" class="form-input-admin text-sm p-2 mt-1" value="<span class="math-inline">\{option\.price\}" placeholder\="Ex\: 75\.00" required\></div\>
<div\><label class\="text\-xs font\-medium text\-brand\-near\-black"\>Stock Initial/Actuel <span class\="text\-red\-500"\>\*</span\></label\><input type\="number" name\="weight\_options\[</span>{optionIndex}][initial_stock]" step="1" min="0" class="form-input-admin text-sm p-2 mt-1" value="${option.initial_stock}" placeholder="Ex: 10" required></div>
            <button type="button" class="btn-admin-danger text-xs py-1 px-2 self-end mt-4 md:mt-0" onclick="this.parentElement.remove()">Retirer</button>
        </div>`;
    container.insertAdjacentHTML('beforeend', rowHtml);
}

async function handleProductFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const assetsPreviewSection = document.getElementById('product-assets-preview-section');
    const assetsLinksContainer = document.getElementById('product-assets-links');
    if(assetsPreviewSection) assetsPreviewSection.style.display = 'none';
    if(assetsLinksContainer) assetsLinksContainer.innerHTML = '';

    clearFormErrors(form);
    if (!validateProductForm(form)) return;

    const formData = new FormData(form);
    const productData = {};

    const fieldsToCollect = [
        'id', 'name_fr', 'name_en', 'category',
        'short_description_fr', 'short_description_en',
        'long_description_fr', 'long_description_en',
        'image_url_main', 'image_urls_thumb',
        'species_fr', 'species_en', 'origin_fr', 'origin_en',
        'seasonality_fr', 'seasonality_en', 'ideal_uses_fr', 'ideal_uses_en',
        'sensory_description_fr', 'sensory_description_en',
        'pairing_suggestions_fr', 'pairing_suggestions_en',
        'base_price', 'initial_stock_quantity',
        'is_published',
        'numero_lot_manuel', 'date_conditionnement', 'ddm',
        'specific_weight_for_label',
        'ingredients_for_label_fr', 'ingredients_for_label_en'
    ];

    for (const fieldName of fieldsToCollect) {
        if (formData.has(fieldName)) {
            if (['base_price', 'initial_stock_quantity'].includes(fieldName)) {
                productData[fieldName] = formData.get(fieldName) ? parseFloat(formData.get(fieldName)) : null;
                if (fieldName === 'initial_stock_quantity' && productData[fieldName] === null) productData[fieldName] = 0;
            } else if (fieldName === 'is_published') {
                productData[fieldName] = form.querySelector(`#product-is-published`).checked;
            } else if (fieldName === 'image_urls_thumb') {
                try {
                    const thumbString = formData.get('image_urls_thumb');
                    productData.image_urls_thumb = thumbString.trim() ? JSON.parse(thumbString) : [];
                    if (!Array.isArray(productData.image_urls_thumb)) productData.image_urls_thumb = [];
                } catch (e) {
                    productData.image_urls_thumb = [];
                    setFieldError(form.querySelector('#product-image-urls-thumb'), "Format JSON invalide.");
                    return;
                }
            } else {
                productData[fieldName] = formData.get(fieldName);
            }
        }
    }

    const weightOptions = [];
    document.querySelectorAll('#weight-options-container .weight-option-row').forEach((row) => {
        const optionIdField = row.querySelector(`input[name*="[option_id]"]`);
        const weightGramsField = row.querySelector(`input[name*="[weight_grams]"]`);
        const priceField = row.querySelector(`input[name*="[price]"]`);
        const initialStockField = row.querySelector(`input[name*="[initial_stock]"]`);
        if (weightGramsField && priceField && initialStockField && weightGramsField.value && priceField.value && initialStockField.value) {
            const opt = {
                weight_grams: parseInt(weightGramsField.value),
                price: parseFloat(priceField.value),
                initial_stock: parseInt(initialStockField.value)
            };
            if(optionIdField && optionIdField.value) opt.option_id = parseInt(optionIdField.value);
            weightOptions.push(opt);
        }
    });

    if (weightOptions.length > 0) {
        productData.weight_options = weightOptions;
        productData.base_price = null;
        productData.initial_stock_quantity = 0;
    } else {
        if (productData.base_price === null || productData.base_price === '') {
             // If no variants, base_price is required (validateProductForm should handle this)
        }
        if(productData.initial_stock_quantity === null || productData.initial_stock_quantity === '') productData.initial_stock_quantity = 0;
    }

    const method = editingProductId ? 'PUT' : 'POST';
    const endpoint = editingProductId ? `/products/${editingProductId}` : '/products';

    try {
        showAdminToast("Enregistrement du produit...", "info");
        const result = await adminApiRequest(endpoint, method, productData);

        if (result.success && result.product) {
            showAdminToast(result.message || "Produit enregistré avec succès!", "success");
            if (result.product.assets && assetsPreviewSection && assetsLinksContainer) {
                let linksHtml = '';
                if (result.product.assets.passport_url) linksHtml += `<p><strong>Passeport:</strong> <a href="<span class="math-inline">\{result\.product\.assets\.passport\_url\}" target\="\_blank" class\="text\-brand\-classic\-gold hover\:underline"\></span>{result.product.assets.passport_url}</a></p>`;
                if (result.product.assets.qr_code_file_path) linksHtml += `<p><strong>QR Code:</strong> <a href="/static_assets/${result.product.assets.qr_code_file_path}" target="_blank" class="text-brand-classic-gold hover:underline">Voir QR</a></p>`;
                if (result.product.assets.label_file_path) linksHtml += `<p><strong>Étiquette:</strong> <a href="/static_assets/${result.product.assets.label_file_path}" target="_blank" class="text-brand-classic-gold hover:underline">Voir Étiquette</a></p>`;

                if (linksHtml) {
                    assetsLinksContainer.innerHTML = linksHtml;
                    assetsPreviewSection.style.display = 'block';
                } else {
                    assetsLinksContainer.innerHTML = '<p class="text-brand-warm-taupe">Aucun actif spécifique généré.</p>';
                    assetsPreviewSection.style.display = 'block';
                }
            }
            editingProductId = result.product.id;
            document.getElementById('product-form-title').textContent = `Modifier le Produit: ${result.product.name_fr || result.product.name_en}`;
            document.getElementById('product-id').readOnly = true;
            loadAdminProductsList();
        }
    } catch (error) {
        console.error("Erreur soumission formulaire produit:", error);
    }
}

function validateProductForm(form) {
    let isValid = true;
    const requiredFields = [
        { id: 'product-name-fr', message: "Le nom du produit (FR) est requis." },
        // { id: 'product-name-en', message: "Product Name (EN) is required." }, // At least one name is good
        { id: 'product-category', message: "La catégorie est requise." },
        { id: 'product-image-url-main', message: "L'URL de l'image principale est requise." }
    ];
    if (!editingProductId) {
        requiredFields.unshift({ id: 'product-id', message: "L'ID du produit est requis." });
    }

    // Check at least one name is filled
    const nameFr = form.querySelector('#product-name-fr').value.trim();
    const nameEn = form.querySelector('#product-name-en').value.trim();
    if (!nameFr && !nameEn) {
        setFieldError(form.querySelector('#product-name-fr'), "Au moins un nom de produit (FR ou EN) est requis.");
        setFieldError(form.querySelector('#product-name-en'), "Au moins un nom de produit (FR ou EN) est requis.");
        isValid = false;
    }


    requiredFields.forEach(fieldInfo => {
        const field = form.querySelector(`#${fieldInfo.id}`);
        if (field && !field.value.trim()) {
            // Skip name validation if one of them is filled
            if ((fieldInfo.id === 'product-name-fr' && nameEn) || (fieldInfo.id === 'product-name-en' && nameFr)) {
                // one of the names is filled, so this specific one is not strictly required
            } else {
                setFieldError(field, fieldInfo.message);
                isValid = false;
            }
        }
    });
    // ... (rest of the validation, URL checks, JSON parsing for thumbs)
    const basePriceField = form.querySelector('#product-base-price');
    const weightOptionsRows = form.querySelectorAll('#weight-options-container .weight-option-row');
    if ((!basePriceField.value || basePriceField.value.trim() === '') && weightOptionsRows.length === 0) {
        setFieldError(basePriceField, "Un prix de base ou au moins une option de poids est requis.");
        isValid = false;
    }
    if (basePriceField.value && basePriceField.value.trim() !== '' && weightOptionsRows.length > 0) {
        setFieldError(basePriceField, "Ne pas spécifier de prix de base si des options de poids sont définies.");
        isValid = false;
    }

    if (!isValid) showAdminToast("Veuillez corriger les erreurs dans le formulaire.", "error");
    return isValid;
}

async function loadAdminProductsList() {
    const tableBody = document.getElementById('products-table-body');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Chargement des produits...</td></tr>'; // Adjusted colspan
    try {
        productsForAdmin = await adminApiRequest('/products');
        if (productsForAdmin.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Aucun produit trouvé.</td></tr>'; // Adjusted colspan
            return;
        }
        let rowsHtml = '';
        productsForAdmin.forEach(product => {
            let priceDisplay = product.base_price !== null ? `${parseFloat(product.base_price).toFixed(2)} €` : 'Variantes';
            let stockDisplay = product.stock_quantity !== undefined ? product.stock_quantity : 'N/A';
            // Display French name by default in the list, or English if French is missing
            let displayName = product.name_fr || product.name_en || product.id;
            rowsHtml += `
                <tr>
                    <td class="px-6 py-3 text-xs"><span class="math-inline">\{product\.id\}</td\>
<td class\="px\-6 py\-3 font\-medium text\-brand\-near\-black"\></span>{displayName}</td>
                    <td class="px-6 py-3"><span class="math-inline">\{product\.category\}</td\>
<td class\="px\-6 py\-3"\></span>{priceDisplay}</td>
                    <td class="px-6 py-3"><span class="math-inline">\{stockDisplay\}</td\>
<td class\="px\-6 py\-3"\></span>{product.is_published ? '<span class="text-green-600 font-semibold">Oui</span>' : '<span class="text-red-600">Non</span>'}</td>
                    <td class="px-6 py-3 space-x-2 whitespace-nowrap">
                        <button onclick="editProduct('${product.id}')" class="btn-admin-secondary text-xs p-1.5">Éditer</button>
                    </td>
                </tr>`;
        });
        tableBody.innerHTML = rowsHtml;
    } catch (error) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-600">Erreur de chargement.</td></tr>'; // Adjusted colspan
    }
}

async function editProduct(productId) {
    editingProductId = productId;
    let productToEdit;
    const assetsPreviewSection = document.getElementById('product-assets-preview-section');
    const assetsLinksContainer = document.getElementById('product-assets-links');
    if(assetsPreviewSection) assetsPreviewSection.style.display = 'none';
    if(assetsLinksContainer) assetsLinksContainer.innerHTML = '';

    try {
        productToEdit = await adminApiRequest(`/products/${productId}`); // This endpoint now returns all localized fields
        if (!productToEdit) throw new Error("Produit non trouvé.");
    } catch (e) {
        showAdminToast("Impossible de charger les détails du produit.", "error");
        return;
    }

    const form = document.getElementById('product-form');
    if (!form) return;
    form.reset();
    clearFormErrors(form);

    document.getElementById('product-form-title
